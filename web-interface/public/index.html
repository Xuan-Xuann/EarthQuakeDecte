<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°éœ‡æ£€æµ‹å¹³å° - å®æ—¶ç›‘æ§</title>
    <!-- ä½¿ç”¨CDNå¼•å…¥Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        .pps-stat {
            background-color: #e74c3c;
            color: white;
        }
        .pps-stat .stat-value {
            color: white;
        }
        .pps-stat .stat-label {
            color: #fadbd8;
        }
        .section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .devices-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .device-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .device-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            color: white;
        }
        .status-connected {
            background-color: #2ecc71;
        }
        .status-disconnected {
            background-color: #e74c3c;
        }
        .recent-data-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .data-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .earthquake-warning {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .alert-high {
            background-color: #f8d7da;
            color: #721c24;
        }
        .alert-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        .alert-low {
            background-color: #cce7ff;
            color: #004085;
        }
        .last-updated {
            text-align: right;
            color: #7f8c8d;
            font-style: italic;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .connected {
            background-color: #2ecc71;
        }
        .disconnected {
            background-color: #e74c3c;
        }
        .checking {
            background-color: #f39c12;
        }
        .status-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .refresh-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover {
            background-color: #2980b9;
        }
        .refresh-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .chart-btn {
            padding: 8px 15px;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
        }
        .chart-btn.active {
            background-color: #3498db;
            color: white;
        }
        .intensity-display {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.9em;
            margin-left: 5px;
        }
        .intensity-I { background-color: #E6E6FA; color: black; }
        .intensity-II { background-color: #D8BFD8; color: black; }
        .intensity-III { background-color: #9370DB; color: white; }
        .intensity-IV { background-color: #6A5ACD; color: white; }
        .intensity-V { background-color: #483D8B; color: white; }
        .intensity-VI { background-color: #FFA500; color: black; }
        .intensity-VII { background-color: #FF8C00; color: white; }
        .intensity-VIII { background-color: #FF4500; color: white; }
        .intensity-IX { background-color: #DC143C; color: white; }
        .intensity-X { background-color: #8B0000; color: white; }
        .intensity-XI { background-color: #2F4F4F; color: white; }
        .intensity-XII { background-color: #000000; color: white; }
    </style>
</head>
<body>
    <div class="connection-status checking" id="connection-status">æ­£åœ¨æ£€æµ‹è¿æ¥...</div>
    
    <div class="container">
        <header>
            <h1>ğŸŒ åœ°éœ‡æ£€æµ‹å¹³å°</h1>
            <p class="subtitle">å®æ—¶ç›‘æ§ç•Œé¢ - ç«¯å£ 9000</p>
        </header>
        
        <div class="status-info">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="devices-count">0</div>
                    <div class="stat-label">æ³¨å†Œè®¾å¤‡</div>
                </div>
                <div class="stat-card pps-stat">
                    <div class="stat-value" id="pps-count">0</div>
                    <div class="stat-label">æ•°æ®åŒ…/ç§’</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uptime">0</div>
                    <div class="stat-label">è¿è¡Œæ—¶é—´(ç§’)</div>
                </div>
            </div>
            <button class="refresh-btn" id="refresh-btn" onclick="manualRefresh()">æ‰‹åŠ¨åˆ·æ–°æ•°æ®</button>
        </div>
        
        <div class="section">
            <h2>è®¾å¤‡çŠ¶æ€</h2>
            <div id="devices-container" class="devices-list">
                <!-- è®¾å¤‡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->
                <div id="no-devices-message" class="device-card">æš‚æ— è®¾å¤‡æ•°æ®</div>
            </div>
        </div>
        
        <div class="section">
            <h2>å®æ—¶ä¼ æ„Ÿå™¨æ•°æ®å›¾è¡¨</h2>
            <div class="chart-controls">
                <button class="chart-btn active" onclick="switchChart('acceleration')">åŠ é€Ÿåº¦ (ax, ay, az)</button>
                <button class="chart-btn" onclick="switchChart('gyroscope')">é™€èºä»ª (gx, gy, gz)</button>
            </div>
            <div class="chart-container">
                <canvas id="sensorChart"></canvas>
            </div>
            <div id="no-chart-data" style="text-align: center; padding: 50px; color: #7f8c8d;">æš‚æ— ä¼ æ„Ÿå™¨æ•°æ®</div>
        </div>
        
        <div class="section">
            <h2>å®æ—¶æ•°æ®æµ</h2>
            <div id="recent-data-container" class="recent-data-list">
                <!-- æœ€è¿‘æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->
                <div id="no-data-message" class="data-item">æš‚æ— æ•°æ®</div>
            </div>
        </div>
        
        <div class="last-updated">
            æœ€åæ›´æ–°: <span id="last-updated">-</span>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // è¿æ¥åˆ°åç«¯æœåŠ¡å™¨
        let socket = null;
        let connectionStatus = 'checking'; // checking, connected, disconnected
        let backendConnected = false; // åç«¯æœåŠ¡å™¨è¿æ¥çŠ¶æ€
        
        // å›¾è¡¨ç›¸å…³å˜é‡
        let sensorChart = null;
        let currentChartType = 'acceleration'; // é»˜è®¤æ˜¾ç¤ºåŠ é€Ÿåº¦è®¡æ•°æ®
        let chartDataCache = {}; // ç¼“å­˜æ‰€æœ‰è®¾å¤‡çš„å›¾è¡¨æ•°æ®
        
        // æ§åˆ¶æ›´æ–°é¢‘ç‡
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 500; // 500msæ›´æ–°ä¸€æ¬¡ï¼Œå‡æ…¢æ›´æ–°é€Ÿåº¦
        
        function connect() {
            try {
                socket = io({
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: Infinity
                });
                
                // å°è¯•è¿æ¥æ—¶æ›´æ–°çŠ¶æ€
                socket.on('connect', () => {
                    updateFrontendConnectionStatus('connected');
                    console.log('å·²è¿æ¥åˆ°å‰ç«¯æœåŠ¡å™¨');
                    
                    // è¯·æ±‚æœ€æ–°çš„æ•°æ®
                    requestLatestData();
                });
                
                socket.on('disconnect', (reason) => {
                    updateFrontendConnectionStatus('disconnected');
                    console.log('ä¸å‰ç«¯æœåŠ¡å™¨æ–­å¼€è¿æ¥:', reason);
                });
                
                socket.on('connect_error', (error) => {
                    updateFrontendConnectionStatus('disconnected');
                    console.error('è¿æ¥å‰ç«¯æœåŠ¡å™¨å‡ºé”™:', error);
                });
                
                // ç›‘å¬åç«¯æœåŠ¡å™¨è¿æ¥çŠ¶æ€
                socket.on('connection_status', (data) => {
                    updateBackendConnectionStatus(data.connected);
                });
                
                // ç›‘å¬å„ç§æ•°æ®æ›´æ–°äº‹ä»¶
                setupEventListeners();
            } catch (error) {
                console.error('åˆå§‹åŒ–Socket.IOè¿æ¥å¤±è´¥:', error);
                updateFrontendConnectionStatus('disconnected');
            }
        }
        
        function updateFrontendConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            statusEl.classList.remove('checking', 'connected', 'disconnected');
            
            if (status === 'checking') {
                statusEl.textContent = 'æ­£åœ¨æ£€æµ‹è¿æ¥...';
                statusEl.classList.add('checking');
            } else if (status === 'connected') {
                statusEl.textContent = backendConnected ? 
                    'âœ… å·²è¿æ¥åˆ°å‰ç«¯æœåŠ¡å™¨ï¼Œåç«¯æœåŠ¡å™¨æ­£å¸¸' : 
                    'âš ï¸ å·²è¿æ¥åˆ°å‰ç«¯æœåŠ¡å™¨ï¼Œåç«¯æœåŠ¡å™¨å¼‚å¸¸';
                statusEl.classList.add(backendConnected ? 'connected' : 'disconnected');
            } else if (status === 'disconnected') {
                statusEl.textContent = 'âŒ ä¸å‰ç«¯æœåŠ¡å™¨æ–­å¼€è¿æ¥';
                statusEl.classList.add('disconnected');
            }
            
            connectionStatus = status;
        }
        
        function updateBackendConnectionStatus(connected) {
            backendConnected = connected;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            if (connectionStatus === 'connected') {
                updateFrontendConnectionStatus('connected');
            }
        }
        
        function requestLatestData() {
            if (socket) {
                socket.emit('request_latest_data');
            }
        }
        
        function setupEventListeners() {
            // æ›´æ–°æœåŠ¡å™¨å¥åº·çŠ¶æ€
            socket.on('server_health', (data) => {
                // document.getElementById('connections-count').textContent = data.connections || 0;  // åˆ é™¤æ´»åŠ¨è¿æ¥ç»Ÿè®¡
                document.getElementById('devices-count').textContent = data.devices || 0;
                document.getElementById('uptime').textContent = Math.round(data.uptime) || 0;
                document.getElementById('pps-count').textContent = data.pps || 0;  // æ·»åŠ PPSç»Ÿè®¡
                document.getElementById('last-updated').textContent = new Date().toLocaleString();
                
                // ç§»é™¤æš‚æ— æ•°æ®æç¤º
                removePlaceholderMessages();
            });
            
            // æ›´æ–°è®¾å¤‡æ•°æ®
            socket.on('devices_data', (data) => {
                const container = document.getElementById('devices-container');
                container.innerHTML = '';
                
                if (!data.devices || data.devices.length === 0) {
                    container.innerHTML = '<div class="device-card">æš‚æ— è®¾å¤‡æ•°æ®</div>';
                    return;
                }
                
                data.devices.forEach(device => {
                    const deviceCard = document.createElement('div');
                    deviceCard.className = 'device-card';
                    
                    // å¤„ç†è®¾å¤‡IDæ˜¾ç¤º
                    const deviceId = device.device_id.replace('device_', '');
                    
                    // æ ¹æ®lastSeenæ—¶é—´åˆ¤æ–­è®¾å¤‡æ˜¯å¦åœ¨çº¿ï¼ˆå¦‚æœåœ¨è¿‡å»5åˆ†é’Ÿå†…æœ‰æ´»åŠ¨åˆ™è®¤ä¸ºåœ¨çº¿ï¼‰
                    const lastSeen = device.lastSeen ? new Date(device.lastSeen) : null;
                    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                    const isOnline = lastSeen && lastSeen > fiveMinutesAgo;
                    
                    const statusClass = isOnline ? 'status-connected' : 'status-disconnected';
                    const statusText = isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
                    
                    // æ˜¾ç¤ºæ›´å¤šè®¾å¤‡ä¿¡æ¯
                    const lastData = device.lastData;
                    
                    let lastDataDisplay = '';
                    if (lastData) {
                        lastDataDisplay = `
                            <p><strong>æœ€åæ•°æ®:</strong> éœ‡çº§ ${lastData.magnitude !== undefined && lastData.magnitude !== null && !isNaN(lastData.magnitude) ? parseFloat(lastData.magnitude).toFixed(4) : 'N/A'} | çƒˆåº¦ ${lastData.intensity !== undefined && lastData.intensity !== null && !isNaN(lastData.intensity) ? parseFloat(lastData.intensity).toFixed(1) : 'N/A'} | ç±»å‹ ${lastData.earthquake_type !== undefined && lastData.earthquake_type !== null ? lastData.earthquake_type : 'N/A'}</p>
                            <p><strong>éœ‡åº¦:</strong> ${lastData.jma_intensity !== undefined && lastData.jma_intensity !== null && !isNaN(lastData.jma_intensity) ? parseFloat(lastData.jma_intensity).toFixed(1) : 'N/A'} | PGA: ${lastData.pga !== undefined && lastData.pga !== null && !isNaN(lastData.pga) ? parseFloat(lastData.pga).toFixed(3) : 'N/A'}</p>
                            <p><strong>è­¦æŠ¥:</strong> <span class="alert-${lastData.alert_level ? lastData.alert_level.toLowerCase() : 'normal'}">${lastData.alert_level !== undefined && lastData.alert_level !== null ? lastData.alert_level : 'N/A'}</span></p>
                        `;
                    } else {
                        lastDataDisplay = '<p><em>æš‚æ— æ•°æ®è®°å½•</em></p>';
                    }

                    deviceCard.innerHTML = `
                        <h3>${deviceId}</h3>
                        <p><strong>çŠ¶æ€:</strong> 
                            <span class="device-status ${statusClass}">${statusText}</span>
                        </p>
                        <p><strong>ä½ç½®:</strong> ${device.location || 'æœªæŒ‡å®š'}</p>
                        <p><strong>æœ€åè¿æ¥:</strong> ${lastSeen ? lastSeen.toLocaleString() : 'N/A'}</p>
                        <p><strong>æœ€åæ´»åŠ¨:</strong> ${lastSeen ? lastSeen.toLocaleString() : 'N/A'}</p>
                        ${lastDataDisplay}
                    `;
                    
                    container.appendChild(deviceCard);
                });
                
                // æ›´æ–°è®¾å¤‡è®¡æ•°
                document.getElementById('devices-count').textContent = data.devices ? data.devices.length : 0;
                
                // ç§»é™¤æš‚æ— æ•°æ®æç¤º
                removePlaceholderMessages();
            });
            
            // æ›´æ–°æœ€è¿‘æ•°æ®
            socket.on('recent_data', (data) => {
                const container = document.getElementById('recent-data-container');
                
                if (!data.recent_data || data.recent_data.length === 0) {
                    container.innerHTML = '<div class="data-item">æš‚æ— æ•°æ®</div>';
                    return;
                }
                
                // æ¸…ç©ºå®¹å™¨
                container.innerHTML = '';
                
                // æ˜¾ç¤ºæœ€è¿‘çš„10æ¡æ•°æ®
                const recentItems = data.recent_data.slice(-10).reverse();
                
                recentItems.forEach(item => {
                    const dataItem = document.createElement('div');
                    dataItem.className = `data-item ${item.alert_level ? 'earthquake-warning' : ''}`;
                    
                    const alertClass = item.alert_level ? item.alert_level.toLowerCase() : 'normal';
                    
                    dataItem.innerHTML = `
                        <div class="${alertClass}">
                            ${item.alert_level ? '<strong>ğŸš¨ åœ°éœ‡è­¦æŠ¥!</strong><br>' : ''}
                            <strong>è®¾å¤‡:</strong> ${item.device_id} | 
                            <strong>éœ‡çº§:</strong> ${item.magnitude !== undefined && item.magnitude !== null && !isNaN(item.magnitude) ? parseFloat(item.magnitude).toFixed(4) : 'N/A'} | 
                            <strong>çƒˆåº¦:</strong> ${item.intensity !== undefined && item.intensity !== null && !isNaN(item.intensity) ? parseFloat(item.intensity).toFixed(1) : 'N/A'} | 
                            <strong>éœ‡åº¦:</strong> ${item.jma_intensity !== undefined && item.jma_intensity !== null && !isNaN(item.jma_intensity) ? parseFloat(item.jma_intensity).toFixed(1) : 'N/A'} | 
                            <strong>PGA:</strong> ${item.pga !== undefined && item.pga !== null && !isNaN(item.pga) ? parseFloat(item.pga).toFixed(3) : 'N/A'} m/sÂ² | 
                            <strong>ç±»å‹:</strong> ${item.earthquake_type !== undefined && item.earthquake_type !== null ? item.earthquake_type : 'N/A'} | 
                            <strong>è­¦æŠ¥:</strong> <span class="alert-${alertClass}">${item.alert_level !== undefined && item.alert_level !== null ? item.alert_level : 'N/A'}</span> | 
                            <strong>AX:</strong> ${item.ax !== undefined && item.ax !== null && !isNaN(item.ax) ? parseFloat(item.ax).toFixed(2) : 'N/A'} | 
                            <strong>AY:</strong> ${item.ay !== undefined && item.ay !== null && !isNaN(item.ay) ? parseFloat(item.ay).toFixed(2) : 'N/A'} | 
                            <strong>AZ:</strong> ${item.az !== undefined && item.az !== null && !isNaN(item.az) ? parseFloat(item.az).toFixed(2) : 'N/A'} | 
                            <strong>GX:</strong> ${item.gx !== undefined && item.gx !== null && !isNaN(item.gx) ? parseFloat(item.gx).toFixed(2) : 'N/A'} | 
                            <strong>GY:</strong> ${item.gy !== undefined && item.gy !== null && !isNaN(item.gy) ? parseFloat(item.gy).toFixed(2) : 'N/A'} | 
                            <strong>GZ:</strong> ${item.gz !== undefined && item.gz !== null && !isNaN(item.gz) ? parseFloat(item.gz).toFixed(2) : 'N/A'} | 
                            <strong>çŠ¶æ€:</strong> ${item.is_earthquake ? 'ğŸš¨åœ°éœ‡' : 'âœ…æ­£å¸¸'} | 
                            <strong>æ—¶é—´:</strong> ${item.server_timestamp || item.timestamp ? new Date(item.server_timestamp || item.timestamp).toLocaleString() : 'N/A'}
                        </div>
                    `;
                    
                    container.appendChild(dataItem);
                });
                
                // ç§»é™¤æš‚æ— æ•°æ®æç¤º
                removePlaceholderMessages();
            });
            
            // å¤„ç†è¯¦ç»†ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°ï¼ˆç”¨äºå›¾è¡¨ï¼‰
            socket.on('detailed_sensor_data', (data) => {
                // æ§åˆ¶æ›´æ–°é¢‘ç‡
                const now = Date.now();
                if (now - lastUpdateTime < UPDATE_INTERVAL) {
                    return; // è·³è¿‡æ­¤æ¬¡æ›´æ–°
                }
                lastUpdateTime = now;
                
                // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                if (!data || !data.device_id) {
                    console.error('Received invalid detailed sensor data:', data);
                    return;
                }
                
                // ç¼“å­˜æ•°æ®
                chartDataCache[data.device_id] = data;
                
                // å¦‚æœå›¾è¡¨å­˜åœ¨ï¼Œæ›´æ–°å®ƒ
                if (sensorChart) {
                    updateChartWithData(data);
                } else {
                    // å¦‚æœå›¾è¡¨ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–å®ƒå¹¶æ˜¾ç¤ºæ•°æ®
                    initChart();
                    updateChartWithData(data);
                }
                
                // éšè—"æš‚æ— æ•°æ®"æç¤º
                const noChartElement = document.getElementById('no-chart-data');
                if (noChartElement) {
                    noChartElement.style.display = 'none';
                }
            });
            
            // å¤„ç†å®æ—¶ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°
            socket.on('sensor_data', (data) => {
                try {
                    // ç¡®ä¿æ•°æ®æ˜¯å­—ç¬¦ä¸²ç„¶åè½¬æ¢ä¸ºå¯¹è±¡
                    if (typeof data === 'string') {
                        data = JSON.parse(data);
                    }
                    
                    // æ›´æ–°æœ€è¿‘æ•°æ®åˆ—è¡¨çš„é¡¶éƒ¨
                    const container = document.getElementById('recent-data-container');
                    
                    // å¦‚æœæ˜¾ç¤ºçš„æ˜¯å ä½ç¬¦æ¶ˆæ¯ï¼Œåˆ™æ¸…ç©ºå®ƒ
                    if (container.querySelector('#no-data-message')) {
                        container.innerHTML = '';
                    }
                    
                    const dataItem = document.createElement('div');
                    dataItem.className = `data-item ${data.alert_level ? 'earthquake-warning' : ''}`;
                    
                    const alertClass = data.alert_level ? data.alert_level.toLowerCase() : 'normal';
                    
                    dataItem.innerHTML = `
                        <div class="${alertClass}">
                            ${data.alert_level ? '<strong>ğŸš¨ åœ°éœ‡è­¦æŠ¥!</strong><br>' : ''}
                            <strong>è®¾å¤‡:</strong> ${data.device_id} | 
                            <strong>éœ‡çº§:</strong> ${data.magnitude !== undefined && data.magnitude !== null && !isNaN(data.magnitude) ? parseFloat(data.magnitude).toFixed(4) : 'N/A'} | 
                            <strong>çƒˆåº¦:</strong> ${data.intensity !== undefined && data.intensity !== null && !isNaN(data.intensity) ? parseFloat(data.intensity).toFixed(1) : 'N/A'} | 
                            <strong>éœ‡åº¦:</strong> ${data.jma_intensity !== undefined && data.jma_intensity !== null && !isNaN(data.jma_intensity) ? parseFloat(data.jma_intensity).toFixed(1) : 'N/A'} | 
                            <strong>PGA:</strong> ${data.pga !== undefined && data.pga !== null && !isNaN(data.pga) ? parseFloat(data.pga).toFixed(3) : 'N/A'} m/sÂ² | 
                            <strong>ç±»å‹:</strong> ${data.earthquake_type !== undefined && data.earthquake_type !== null ? data.earthquake_type : 'N/A'} | 
                            <strong>è­¦æŠ¥:</strong> <span class="alert-${alertClass}">${data.alert_level !== undefined && data.alert_level !== null ? data.alert_level : 'N/A'}</span> | 
                            <strong>AX:</strong> ${data.ax !== undefined && data.ax !== null && !isNaN(data.ax) ? parseFloat(data.ax).toFixed(2) : 'N/A'} | 
                            <strong>AY:</strong> ${data.ay !== undefined && data.ay !== null && !isNaN(data.ay) ? parseFloat(data.ay).toFixed(2) : 'N/A'} | 
                            <strong>AZ:</strong> ${data.az !== undefined && data.az !== null && !isNaN(data.az) ? parseFloat(data.az).toFixed(2) : 'N/A'} | 
                            <strong>GX:</strong> ${data.gx !== undefined && data.gx !== null && !isNaN(data.gx) ? parseFloat(data.gx).toFixed(2) : 'N/A'} | 
                            <strong>GY:</strong> ${data.gy !== undefined && data.gy !== null && !isNaN(data.gy) ? parseFloat(data.gy).toFixed(2) : 'N/A'} | 
                            <strong>GZ:</strong> ${data.gz !== undefined && data.gz !== null && !isNaN(data.gz) ? parseFloat(data.gz).toFixed(2) : 'N/A'} | 
                            <strong>çŠ¶æ€:</strong> ${data.is_earthquake ? 'ğŸš¨åœ°éœ‡' : 'âœ…æ­£å¸¸'} | 
                            <strong>æ—¶é—´:</strong> ${data.server_timestamp || data.timestamp ? new Date(data.server_timestamp || data.timestamp).toLocaleString() : 'N/A'}
                        </div>
                    `;
                    
                    // å°†æ–°æ•°æ®é¡¹æ·»åŠ åˆ°å®¹å™¨çš„é¡¶éƒ¨
                    if (container.firstChild) {
                        container.insertBefore(dataItem, container.firstChild);
                    } else {
                        container.appendChild(dataItem);
                    }
                    
                    // é™åˆ¶æ˜¾ç¤ºçš„æ•°æ®é¡¹æ•°é‡
                    if (container.children.length > 20) {
                        container.removeChild(container.lastChild);
                    }
                } catch (e) {
                    console.error('Error processing sensor_data:', e, data);
                }
            });
            
            // å¤„ç†è®¾å¤‡çŠ¶æ€æ›´æ–°
            socket.on('device_status', (data) => {
                // æ›´æ–°è®¾å¤‡åˆ—è¡¨
                updateDeviceList();
            });
            
            // å¤„ç†è®¾å¤‡çŠ¶æ€æ›´æ–°
            socket.on('device_status_update', (data) => {
                // æ›´æ–°è®¾å¤‡åˆ—è¡¨
                updateDeviceList();
            });
            
            // å¤„ç†åœ°éœ‡è­¦æŠ¥
            socket.on('earthquake_alert', (data) => {
                console.log('åœ°éœ‡è­¦æŠ¥:', data);
                
                // åœ¨æœ€è¿‘æ•°æ®åŒºåŸŸé¡¶éƒ¨æ·»åŠ è­¦æŠ¥
                const alertClass = data.alert_level ? data.alert_level.toLowerCase() : 'normal';
                const alertItem = document.createElement('div');
                alertItem.className = `data-item earthquake-warning`;
                alertItem.innerHTML = `
                    <strong>ğŸš¨ åœ°éœ‡è­¦æŠ¥!</strong><br>
                    <strong>è®¾å¤‡:</strong> ${data.device_id} | 
                    <strong>éœ‡çº§:</strong> ${data.magnitude !== undefined && data.magnitude !== null && !isNaN(data.magnitude) ? parseFloat(data.magnitude).toFixed(4) : 'N/A'} | 
                    <strong>çƒˆåº¦:</strong> ${data.intensity !== undefined && data.intensity !== null && !isNaN(data.intensity) ? parseFloat(data.intensity).toFixed(1) : 'N/A'} | 
                    <strong>éœ‡åº¦:</strong> ${data.jma_intensity !== undefined && data.jma_intensity !== null && !isNaN(data.jma_intensity) ? parseFloat(data.jma_intensity).toFixed(1) : 'N/A'} | 
                    <strong>PGA:</strong> ${data.pga !== undefined && data.pga !== null && !isNaN(data.pga) ? parseFloat(data.pga).toFixed(3) : 'N/A'} m/sÂ² | 
                    <strong>ç±»å‹:</strong> ${data.earthquake_type !== undefined && data.earthquake_type !== null ? data.earthquake_type : 'N/A'} | 
                    <strong>è­¦æŠ¥:</strong> <span class="alert-${data.alert_level ? data.alert_level.toLowerCase() : 'normal'}">${data.alert_level !== undefined && data.alert_level !== null ? data.alert_level : 'N/A'}</span> | 
                    <strong>AX:</strong> ${data.ax !== undefined && data.ax !== null && !isNaN(data.ax) ? parseFloat(data.ax).toFixed(2) : 'N/A'} | 
                    <strong>AY:</strong> ${data.ay !== undefined && data.ay !== null && !isNaN(data.ay) ? parseFloat(data.ay).toFixed(2) : 'N/A'} | 
                    <strong>AZ:</strong> ${data.az !== undefined && data.az !== null && !isNaN(data.az) ? parseFloat(data.az).toFixed(2) : 'N/A'} | 
                    <strong>GX:</strong> ${data.gx !== undefined && data.gx !== null && !isNaN(data.gx) ? parseFloat(data.gx).toFixed(2) : 'N/A'} | 
                    <strong>GY:</strong> ${data.gy !== undefined && data.gy !== null && !isNaN(data.gy) ? parseFloat(data.gy).toFixed(2) : 'N/A'} | 
                    <strong>GZ:</strong> ${data.gz !== undefined && data.gz !== null && !isNaN(data.gz) ? parseFloat(data.gz).toFixed(2) : 'N/A'} | 
                    <strong>çŠ¶æ€:</strong> ${data.is_earthquake ? 'ğŸš¨åœ°éœ‡' : 'âœ…æ­£å¸¸'} | 
                    <strong>æ—¶é—´:</strong> ${data.server_timestamp || data.timestamp ? new Date(data.server_timestamp || data.timestamp).toLocaleString() : 'N/A'}
                `;
                
                const recentDataList = document.querySelector('.recent-data-list');
                if (recentDataList.firstChild) {
                    recentDataList.insertBefore(alertItem, recentDataList.firstChild);
                } else {
                    recentDataList.appendChild(alertItem);
                }
                
                // æ›´æ–°è®¾å¤‡åˆ—è¡¨ä¸­çš„æœ€åæ•°æ®
                updateDeviceList();
                
                // æ›´æ–°å›¾è¡¨æ•°æ®
                if (sensorChart) {
                    // ä¸ºå›¾è¡¨å‡†å¤‡æ•°æ®ç»“æ„
                    const deviceId = data.device_id;
                    if (!chartDataCache[deviceId]) {
                        chartDataCache[deviceId] = {
                            timestamps: [],
                            ax: [],
                            ay: [],
                            az: [],
                            gx: [],
                            gy: [],
                            gz: []
                        };
                    }
                    
                    // æ·»åŠ æ–°æ•°æ®ç‚¹
                    chartDataCache[deviceId].timestamps.push(data.server_timestamp || data.timestamp);
                    chartDataCache[deviceId].ax.push(data.ax);
                    chartDataCache[deviceId].ay.push(data.ay);
                    chartDataCache[deviceId].az.push(data.az);
                    chartDataCache[deviceId].gx.push(data.gx);
                    chartDataCache[deviceId].gy.push(data.gy);
                    chartDataCache[deviceId].gz.push(data.gz);
                    
                    // é™åˆ¶æ•°æ®ç‚¹æ•°é‡ï¼Œä¿ç•™æœ€æ–°çš„50ä¸ªæ•°æ®ç‚¹
                    const maxDataPoints = 50;
                    if (chartDataCache[deviceId].timestamps.length > maxDataPoints) {
                        chartDataCache[deviceId].timestamps = chartDataCache[deviceId].timestamps.slice(-maxDataPoints);
                        chartDataCache[deviceId].ax = chartDataCache[deviceId].ax.slice(-maxDataPoints);
                        chartDataCache[deviceId].ay = chartDataCache[deviceId].ay.slice(-maxDataPoints);
                        chartDataCache[deviceId].az = chartDataCache[deviceId].az.slice(-maxDataPoints);
                        chartDataCache[deviceId].gx = chartDataCache[deviceId].gx.slice(-maxDataPoints);
                        chartDataCache[deviceId].gy = chartDataCache[deviceId].gy.slice(-maxDataPoints);
                        chartDataCache[deviceId].gz = chartDataCache[deviceId].gz.slice(-maxDataPoints);
                    }
                    
                    updateChartWithData(chartDataCache[deviceId]);
                }
            });
            
            // å¤„ç†æœåŠ¡å™¨å¥åº·çŠ¶æ€
            socket.on('server_health', (data) => {
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                if (data.pps !== undefined) {
                    const ppsEl = document.getElementById('pps-count');
                    if (ppsEl) {
                        ppsEl.textContent = data.pps;
                    }
                }
                if (data.devices !== undefined) {
                    const devicesEl = document.querySelector('.devices-stat .stat-value');
                    if (devicesEl) {
                        devicesEl.textContent = data.devices;
                    }
                }
                if (data.uptime !== undefined) {
                    const uptimeEl = document.querySelector('.uptime-stat .stat-value');
                    if (uptimeEl) {
                        uptimeEl.textContent = Math.floor(data.uptime);
                    }
                }
                
                // æ›´æ–°è®¾å¤‡åˆ—è¡¨
                updateDeviceList();
            });
            
            // å¤„ç†æ•°æ®åŒ…ç»Ÿè®¡
            socket.on('packet_stats', (data) => {
                if (data.pps !== undefined) {
                    const ppsEl = document.querySelector('.pps-stat .stat-value');
                    if (ppsEl) {
                        ppsEl.textContent = data.pps;
                    }
                }
            });
        }
        
        function removePlaceholderMessages() {
            const noDevicesMsg = document.getElementById('no-devices-message');
            if (noDevicesMsg) noDevicesMsg.remove();
            
            const noDataMsg = document.getElementById('no-data-message');
            if (noDataMsg) noDataMsg.remove();
        }
        
        function manualRefresh() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = 'åˆ·æ–°ä¸­...';
            
            // è¯·æ±‚æœ€æ–°æ•°æ®
            requestLatestData();
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = 'æ‰‹åŠ¨åˆ·æ–°æ•°æ®';
            }, 2000);
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.js library not loaded yet.');
                setTimeout(initChart, 1000); // 1ç§’åé‡è¯•
                return;
            }
            
            const ctx = document.getElementById('sensorChart').getContext('2d');
            
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æ•°å€¼'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    animation: {
                        duration: 300 // åŠ¨ç”»æŒç»­æ—¶é—´ï¼Œå‡å°‘å»¶è¿Ÿ
                    },
                    // å®ç°å®æ—¶æ›´æ–°æ•ˆæœ
                    spanGaps: true, // è¿æ¥æ•°æ®ç‚¹
                    lineTension: 0.1,
                    elements: {
                        point: {
                            radius: 0 // ä¸æ˜¾ç¤ºæ•°æ®ç‚¹ï¼Œä½¿çº¿æ¡æ›´å¹³æ»‘
                        }
                    }
                }
            });
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateChartWithData(data) {
            // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.js library not loaded yet.');
                return;
            }
            
            if (!sensorChart) {
                console.warn('Chart not initialized yet.');
                return;
            }
            
            // å°†å½“å‰æ•°æ®å­˜å…¥ç¼“å­˜
            if (data.device_id) {
                chartDataCache[data.device_id] = data;
            }
            
            // è¿‡æ»¤æ‰ç©ºæ•°æ®
            if (!data.timestamps || data.timestamps.length === 0) {
                return;
            }
            
            // éªŒè¯æ•°æ®é•¿åº¦æ˜¯å¦ä¸€è‡´
            let validData = ['ax', 'ay', 'az', 'gx', 'gy', 'gz'].map(sensor => data[sensor]).filter(d => d && d.length === data.timestamps.length);
            
            if (validData.length === 0) {
                console.warn('Invalid or inconsistent data for chart update:', data);
                return;
            }
            
            let datasets;
            if (currentChartType === 'acceleration') {
                datasets = [
                    {
                        label: 'AX (åŠ é€Ÿåº¦X)',
                        data: data.ax.map((value, index) => ({
                            x: new Date(data.timestamps[index]).toLocaleTimeString(),
                            y: value
                        })),
                        borderColor: '#FF6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y'
                    },
                    {
                        label: 'AY (åŠ é€Ÿåº¦Y)',
                        data: data.ay.map((value, index) => ({
                            x: new Date(data.timestamps[index]).toLocaleTimeString(),
                            y: value
                        })),
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y'
                    },
                    {
                        label: 'AZ (åŠ é€Ÿåº¦Z)',
                        data: data.az.map((value, index) => ({
                            x: new Date(data.timestamps[index]).toLocaleTimeString(),
                            y: value
                        })),
                        borderColor: '#FFCE56',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y'
                    }
                ];
            } else { // gyroscope
                datasets = [
                    {
                        label: 'GX (é™€èºä»ªX)',
                        data: data.gx.map((value, index) => ({
                            x: new Date(data.timestamps[index]).toLocaleTimeString(),
                            y: value
                        })),
                        borderColor: '#4BC0C0',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y'
                    },
                    {
                        label: 'GY (é™€èºä»ªY)',
                        data: data.gy.map((value, index) => ({
                            x: new Date(data.timestamps[index]).toLocaleTimeString(),
                            y: value
                        })),
                        borderColor: '#9966FF',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y'
                    },
                    {
                        label: 'GZ (é™€èºä»ªZ)',
                        data: data.gz.map((value, index) => ({
                            x: new Date(data.timestamps[index]).toLocaleTimeString(),
                            y: value
                        })),
                        borderColor: '#FF9F40',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y'
                    }
                ];
            }
            
            sensorChart.data.datasets = datasets;
            
            // è®¾ç½®xè½´æ ‡ç­¾
            sensorChart.data.labels = data.timestamps.map(t => new Date(t).toLocaleTimeString());
            
            // ä¸è¦é‡æ–°æ¸²æŸ“æ•´ä¸ªå›¾è¡¨ï¼Œè€Œæ˜¯æ›´æ–°æ•°æ®
            sensorChart.update('none'); // 'none' è¡¨ç¤ºä¸ä½¿ç”¨åŠ¨ç”»
        }
        
        // åˆ‡æ¢å›¾è¡¨ç±»å‹
        function switchChart(type) {
            currentChartType = type;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (type === 'acceleration') {
                document.querySelector('[onclick="switchChart(\'acceleration\')"]').classList.add('active');
            } else {
                document.querySelector('[onclick="switchChart(\'gyroscope\')"]').classList.add('active');
            }
            
            // å¦‚æœæœ‰ç¼“å­˜æ•°æ®ï¼Œæ›´æ–°å›¾è¡¨
            for (const deviceId in chartDataCache) {
                updateChartWithData(chartDataCache[deviceId]);
                break; // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ•°æ®é›†
            }
        }
        
        // æ·»åŠ å®šæ—¶æ¸…ç†æ—§æ•°æ®çš„å‡½æ•°
        function cleanupOldData() {
            const now = Date.now();
            const fiveMinutesAgo = now - 5 * 60 * 1000; // 5åˆ†é’Ÿå‰çš„æ—¶é—´æˆ³
            
            for (const deviceId in chartDataCache) {
                const deviceData = chartDataCache[deviceId];
                
                // æ‰¾åˆ°éœ€è¦ä¿ç•™çš„æ•°æ®ç´¢å¼•
                let keepFromIndex = 0;
                for (let i = 0; i < deviceData.timestamps.length; i++) {
                    if (new Date(deviceData.timestamps[i]).getTime() > fiveMinutesAgo) {
                        keepFromIndex = i;
                        break;
                    }
                }
                
                // å¦‚æœéœ€è¦æ¸…ç†æ—§æ•°æ®
                if (keepFromIndex > 0) {
                    // ä¿ç•™æœ€è¿‘5åˆ†é’Ÿçš„æ•°æ®
                    deviceData.timestamps = deviceData.timestamps.slice(keepFromIndex);
                    deviceData.ax = deviceData.ax.slice(keepFromIndex);
                    deviceData.ay = deviceData.ay.slice(keepFromIndex);
                    deviceData.az = deviceData.az.slice(keepFromIndex);
                    deviceData.gx = deviceData.gx.slice(keepFromIndex);
                    deviceData.gy = deviceData.gy.slice(keepFromIndex);
                    deviceData.gz = deviceData.gz.slice(keepFromIndex);
                    
                    // æ›´æ–°ç¼“å­˜
                    chartDataCache[deviceId] = deviceData;
                    
                    // æ›´æ–°å›¾è¡¨æ˜¾ç¤º
                    updateChartWithData(deviceData);
                }
            }
        }
        
        // æ¯30ç§’æ¸…ç†ä¸€æ¬¡æ—§æ•°æ®
        setInterval(cleanupOldData, 30000);
        
        // åˆå§‹åŒ–è¿æ¥
        connect();
    </script>
</body>
</html>